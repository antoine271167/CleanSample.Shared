parameters:
- name: azureSubscription
  type: string
- name: appName
  type: string
- name: envAppSettings
  type: string
- name: clientId
  type: string
  default: ' '
- name: clientSecret
  type: string
  default: ' '
- name: branch
  type: string
- name: repositoryUrl
  type: string

steps:
- task: AzureCLI@2
  name: CreateStaticWebApp
  displayName: 'Create Static Web App'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      az deployment group create `
        --name ${{parameters.appName}}-dg `
        --resource-group ${{parameters.appName}}-rg `
        --template-file .\Fiberwolf.Resources\bicep\staticwebapp-create.bicep `
        --parameters ${{parameters.envAppSettings}} `
        --parameters clientId='${{parameters.clientId}}' `
        --parameters clientSecret='${{parameters.clientSecret}}' `
        --parameters branch='${{parameters.branch}}' `
        --parameters repositoryUrl='${{parameters.repositoryUrl}}'
      $swaDeploymentToken = az staticwebapp secrets list `
        --name ${{parameters.appName}}-swa `
        --query properties.apiKey
      $swaDeploymentToken = $swaDeploymentToken.Trim('"')
      Write-Host $swaDeploymentToken
      Write-Host "##vso[task.setvariable variable=swaDeploymentToken;isSecret=false;isOutput=true]$($swaDeploymentToken)"
