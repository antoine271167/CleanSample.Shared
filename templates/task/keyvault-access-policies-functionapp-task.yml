parameters:
  - name: azureSubscription
    type: string
  - name: faResourceGroup
    type: string
  - name: functionAppName
    type: string
  - name: kvResourceGroup
    type: string
  - name: keyVaultName
    type: string

steps:
- task: AzureCLI@2
  displayName: 'KeyVault - set access policies'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "# Set access policies Key Vault"
      PRINCIPAL=$(az functionapp identity show \
        --name ${{parameters.functionAppName}} \
        --resource-group ${{parameters.faResourceGroup}} \
        --query principalId -o tsv)
      
      az keyvault set-policy \
        --name ${{parameters.keyVaultName}} \
        --object-id $PRINCIPAL \
        --secret-permissions get \
        --certificate-permissions get \
        --key-permissions get

      echo "# Allow access from all networks"
      az keyvault update \
        --resource-group ${{parameters.kvResourceGroup}} \
        --name ${{parameters.keyVaultName}} \
        --default-action Allow
     