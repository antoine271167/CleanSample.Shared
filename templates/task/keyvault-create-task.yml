parameters:
  - name: azureSubscription
    type: string
  - name: resourceGroup
    type: string
  - name: keyVaultName
    type: string
  
steps:
- task: AzureCLI@2
  displayName: 'Create Key Vault'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      if(((az keyvault list | ConvertFrom-Json) | Where-Object {$_.name -eq "${{parameters.keyVaultName}}"}).count -eq 0)
      {
        Write-Host "# Create Key Vault ${{parameters.keyVaultName}}"
        az keyvault create `
          --resource-group ${{parameters.resourceGroup}} `
          --name ${{parameters.keyVaultName}}
      }
      else
      {
        Write-Host "# Key Vault ${{parameters.keyVaultName}} already exists"
      }
