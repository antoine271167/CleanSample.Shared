parameters:
  - name: azureSubscription
    type: string
  - name: resourceGroup
    type: string
  - name: functionAppName
    type: string
  - name: storageAccountName
    type: string
  - name: location
    type: string
    default: westeurope
  - name: osType
    type: string
    values: 
      - Linux
      - Windows
    default: Windows
  - name: functionsVersion
    type: string
    default: 3
    
steps:
- task: AzureCLI@2
  displayName: 'Create Function App'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "# Check if function app exists"
      echo "az functionapp list --resource-group ${{parameters.resourceGroup}} --query "[?name=='${{parameters.functionAppName}}'].[name]" -o tsv"
      FUNCAPP=$(az functionapp list --resource-group ${{parameters.resourceGroup}} --query "[?name=='${{parameters.functionAppName}}'].[name]" -o tsv)
      echo "$FUNCAPP"
      if [ "$FUNCAPP" = "${{parameters.functionAppName}}" ]; then
        echo "Function app already exists, SKIP"
        exit 0
      fi

      echo "# Create Function App"
      az functionapp create \
        --name ${{parameters.functionAppName}} \
        --storage-account ${{parameters.storageAccountName}} \
        --consumption-plan-location ${{parameters.location}} \
        --resource-group ${{parameters.resourceGroup}} \
        --os-type ${{parameters.osType}} \
        --runtime dotnet \
        --functions-version ${{parameters.functionsVersion}}

      echo "# Enable HTTP 2"
      az functionapp config set \
        --resource-group ${{parameters.resourceGroup}} \
        --name ${{parameters.functionAppName}} \
        --http20-enabled true 

      echo "# Configure web app"
      az webapp log config \
        --resource-group ${{parameters.resourceGroup}} \
        --name ${{parameters.functionAppName}} \
        --detailed-error-messages true \
        --failed-request-tracing true \
        --web-server-logging filesystem

      # Update the Function App to set httpsOnly to true
      echo "# Set httpsOnly on true for Function App"
      az functionapp update \
        --name ${{parameters.functionAppName}} \
        --resource-group ${{parameters.resourceGroup}} \
        --set httpsOnly=true
       
      echo "# Assign managed identity to function app"
      az functionapp identity assign \
        --resource-group ${{parameters.resourceGroup}} \
        --name ${{parameters.functionAppName}}
